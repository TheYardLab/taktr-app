"use strict";exports.id=130,exports.ids=[130],exports.modules={7130:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{default:()=>p});var r=a(997),l=a(6689),n=a(4939),i=a.n(n),o=a(401),d=e([o]);o=(d.then?(await d)():d)[0];let u=["task","start","finish"];function c(e){if(null==e)return"";if("number"==typeof e){let t=new Date(Date.UTC(1899,11,30)),a=new Date(t.getTime()+864e5*e);return Number.isNaN(a.getTime())?"":a.toISOString().slice(0,10)}let t=String(e).trim();if(!t)return"";let a=new Date(t);return Number.isNaN(a.getTime())?/^\d{4}-\d{2}-\d{2}$/.test(t)?t:"":a.toISOString().slice(0,10)}let m=[{label:"Task",key:"task"},{label:"Trade",key:"trade"},{label:"Subcontractor",key:"subcontractor"},{label:"Status",key:"status"},{label:"Start",key:"start"},{label:"Finish",key:"finish"},{label:"Wagon",key:"wagon"},{label:"Train",key:"train"},{label:"Zone",key:"zone"},{label:"Area",key:"area"},{label:"Duration",key:"duration"},{label:"Predecessors",key:"predecessors"}],p=({projectId:e})=>{let[t,a]=(0,l.useState)(""),[s,n]=(0,l.useState)([]),[d,p]=(0,l.useState)([]),[h,x]=(0,l.useState)({}),[g,b]=(0,l.useState)(!1),[f,y]=(0,l.useState)(""),j=s.length,N=(0,l.useMemo)(()=>u.every(e=>!!h[e])&&j>0&&!g,[h,j,g]),S=(0,l.useMemo)(()=>s.slice(0,30),[s]),w=(e,t)=>{x(a=>({...a,[e]:t||void 0}))},k=()=>{if(!s.length)return[];let e=[];for(let t of s){let a=(h.task?String(t[h.task]??""):"").trim(),s=h.start?t[h.start]:null,r=h.finish?t[h.finish]:null,l=c(s),n=c(r);if(!a||!l||!n)continue;let i={name:a,startDate:l,endDate:n,status:function(e){if(!e)return"Not Started";let t=e.toLowerCase();return t.includes("complete")?"Completed":t.includes("done")?"Done":t.includes("block")?"Blocked":t.includes("progress")||t.includes("wip")||t.includes("active")?"In Progress":"Not Started"}(h.status?String(t[h.status]??""):void 0),trade:h.trade&&String(t[h.trade]??"").trim()||null,zone:h.zone&&String(t[h.zone]??"").trim()||null};if(h.subcontractor){let e=String(t[h.subcontractor]??"").trim();e&&(i.trade=i.trade?`${i.trade} — ${e}`:e)}e.push(i)}return e},v=async()=>{try{b(!0),y("");let t=k();if(0===t.length){y("No valid rows to upload (check Task/Start/Finish mapping).");return}let a=(0,o.getAuth)().currentUser;if(!a){y("You must be logged in to upload.");return}let s=await a.getIdToken(),r=await fetch("/api/uploadSchedule",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({projectId:e,tasks:t})}),l=await r.json();if(!r.ok){y(`Upload failed: ${l?.error||r.statusText}`);return}y(`Uploaded ${l?.count??t.length} tasks.`)}catch(e){y(`Upload error: ${e?.message||String(e)}`)}finally{b(!1)}};return(0,r.jsxs)("div",{className:"rounded-md border bg-white p-3",children:[(0,r.jsxs)("div",{className:"mb-2 flex flex-wrap items-center gap-2",children:[(0,r.jsxs)("label",{className:"inline-flex items-center gap-2",children:[r.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{let t=e.target.files?.[0];y(""),t&&(a(t.name),i().parse(t,{header:!0,skipEmptyLines:!0,transformHeader:e=>String(e||"").trim(),complete:e=>{let t=(e.data||[]).filter(Boolean);n(t);let a=e.meta.fields?.map(e=>String(e))||[];p(a);let s=new Set(a.map(e=>e.toLowerCase())),r={...h},l=(e,t)=>{for(let l of t)if(s.has(l.toLowerCase())){let t=a.find(e=>e.toLowerCase()===l.toLowerCase());if(t){r[e]=t;break}}};l("task",["task","name","task name","activity","activity name"]),l("trade",["trade","crew"]),l("subcontractor",["subcontractor","vendor","company"]),l("status",["status","state"]),l("start",["start","start date","planned start","start_date"]),l("finish",["finish","end","end date","planned finish","finish date","finish_date"]),l("zone",["zone","area","location"]),l("area",["area"]),l("wagon",["wagon"]),l("train",["train"]),l("duration",["duration","days"]),l("predecessors",["predecessors","preds","pred"]),x(r)},error:e=>{console.error(e),y(`CSV parse error: ${e?.message||String(e)}`)}}),e.currentTarget.value="")},className:"hidden",id:"csv-input"}),r.jsx("span",{className:"rounded border px-3 py-1.5 text-sm cursor-pointer",children:r.jsx("label",{htmlFor:"csv-input",className:"cursor-pointer",children:"Choose File"})})]}),r.jsx("button",{type:"button",className:"rounded border px-3 py-1.5 text-sm",onClick:()=>{x({}),y("")},children:"Reset Mapping"}),r.jsx("button",{type:"button",className:`rounded px-3 py-1.5 text-sm text-white ${N?"bg-blue-600":"bg-gray-400 cursor-not-allowed"}`,onClick:v,disabled:!N,title:N?"Upload to Project":"Map Task, Start, and Finish first",children:g?"Uploading…":`Upload to Project (${e})`}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 ml-auto",children:[t?`${t} — `:"",j," rows detected"]})]}),(0,r.jsxs)("div",{className:"rounded border bg-gray-50 p-3",children:[(0,r.jsxs)("div",{className:"mb-2 text-sm text-gray-600",children:["Template: ",r.jsx("span",{className:"italic text-gray-500",children:"(none)"})," ",r.jsx("span",{className:"ml-2 text-gray-400",children:"Options come from your CSV header."})]}),r.jsx("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-[900px] w-full text-sm",children:[r.jsx("thead",{children:(0,r.jsxs)("tr",{className:"bg-white",children:[r.jsx("th",{className:"px-3 py-2 text-left w-1/3",children:"Taktr Field"}),r.jsx("th",{className:"px-3 py-2 text-left",children:"Your Column"})]})}),r.jsx("tbody",{className:"bg-white",children:m.map(({label:e,key:t})=>(0,r.jsxs)("tr",{className:"border-t",children:[r.jsx("td",{className:"px-3 py-2 font-medium",children:e}),r.jsx("td",{className:"px-3 py-2",children:(0,r.jsxs)("select",{className:"w-full rounded border px-2 py-1",value:h[t]??"",onChange:e=>w(t,e.target.value),children:[r.jsx("option",{value:"",children:"— Select a column —"}),d.map(e=>r.jsx("option",{value:e,children:e},e))]})})]},t))})]})})]}),(0,r.jsxs)("div",{className:"mt-3",children:[r.jsx("div",{className:"mb-1 text-sm font-semibold",children:"Preview"}),r.jsx("div",{className:"overflow-x-auto rounded border",children:(0,r.jsxs)("table",{className:"min-w-[900px] w-full text-xs",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsx("tr",{children:m.map(({label:e})=>r.jsx("th",{className:"px-2 py-1 text-left",children:e},e))})}),(0,r.jsxs)("tbody",{children:[S.map((e,t)=>r.jsx("tr",{className:"border-t",children:m.map(({key:t})=>r.jsx("td",{className:"px-2 py-1",children:h[t]?String(e[h[t]]??""):""},String(t)))},t)),0===S.length&&r.jsx("tr",{children:r.jsx("td",{className:"px-2 py-2 text-gray-500",colSpan:m.length,children:"Load a CSV to see preview."})})]})]})})]}),f&&r.jsx("div",{className:"mt-3 rounded border bg-yellow-50 px-3 py-2 text-sm",children:f})]})};s()}catch(e){s(e)}})}};