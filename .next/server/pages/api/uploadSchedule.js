"use strict";(()=>{var e={};e.id=317,e.ids=[317],e.modules={5877:e=>{e.exports=require("firebase-admin/auth")},2594:e=>{e.exports=require("firebase-admin/firestore")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},6765:(e,t,r)=>{r.r(t),r.d(t,{config:()=>p,default:()=>c,routeModule:()=>E});var n={};r.r(n),r.d(n,{default:()=>d});var o=r(1802),s=r(7153),i=r(6249),a=r(2091),u=r(2594);function l(e){return!!e&&Number.isFinite(Date.parse(e))}async function d(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(204).end();if("POST"!==e.method)return t.setHeader("Allow",["POST","OPTIONS"]),t.status(405).json({error:"Method not allowed"});let{db:r,auth:n}=a.default;try{let o=(e.headers.authorization||"").trim(),s=o.startsWith("Bearer ")?o.slice(7).trim():"";if(!s||"undefined"===s||"null"===s)return t.status(401).json({error:"Missing bearer token"});let i=(await n.verifyIdToken(s)).uid,{projectId:a,tasks:d=[]}=e.body||{};if(!a||"string"!=typeof a)return t.status(400).json({error:"projectId is required"});if(!Array.isArray(d)||0===d.length)return t.status(400).json({error:"tasks array required"});let c=r.collection("projects").doc(a),p=await c.get();if(!p.exists)return t.status(404).json({error:"Project not found"});let E=p.data()||{},f=E.ownerId===i,A=!!E.members?.[i],_=!1;try{_=(await c.collection("members").doc(i).get()).exists}catch(e){}if(!f&&!A&&!_)return t.status(403).json({error:"Forbidden: not a project member"});let m=c.collection("tasks"),S=r.batch(),P=0;for(let e of d){let t=(e?.name||"").trim(),r=e?.startDate,n=e?.endDate;if(!t||!l(r)||!l(n))continue;let o=(e.id||m.doc().id).toString(),s=m.doc(o);S.set(s,{id:o,projectId:a,name:t,status:function(e){if(!e)return"Not Started";let t=e.toLowerCase();return t.includes("complete")?"Completed":t.includes("done")?"Done":t.includes("block")?"Blocked":t.includes("progress")||t.includes("wip")||t.includes("active")?"In Progress":"Not Started"}(e.status),startDate:r,endDate:n,zone:(e.zone??null)||null,trade:(e.trade??null)||null,updatedAt:u.FieldValue.serverTimestamp(),updatedBy:i,createdAt:u.FieldValue.serverTimestamp()},{merge:!0}),P++}if(0===P)return t.status(400).json({error:"No valid tasks to upload"});return S.set(c,{updatedAt:u.FieldValue.serverTimestamp()},{merge:!0}),await S.commit(),t.status(200).json({ok:!0,count:P})}catch(r){console.error("uploadSchedule error:",r);let e=r?.errorInfo?.message||r?.message||"Server error";if(e.toLowerCase().includes("token"))return t.status(401).json({error:e});return t.status(500).json({error:e})}}let c=(0,i.l)(n,"default"),p=(0,i.l)(n,"config"),E=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/uploadSchedule",pathname:"/api/uploadSchedule",bundlePath:"",filename:""},userland:n})},2091:(e,t,r)=>{r.d(t,{default:()=>u});let n=require("firebase-admin/app");var o=r(2594),s=r(5877);function i(e){if(!e)return null;try{let t=Buffer.from(e,"base64").toString("utf8");return JSON.parse(t)}catch{return null}}let a="__taktr_admin__",u=(()=>{let e=globalThis;return e[a]||(e[a]=function(){let e=(0,n.cert)(function(){let e=process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON,t=function(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}(e)||i(e||"");if(t&&t.client_email&&t.private_key){let e=t.project_id||process.env.FIREBASE_PROJECT_ID,r=t.client_email,n=String(t.private_key).replace(/\\n/g,"\n");if(e&&r&&n)return{projectId:e,clientEmail:r,privateKey:n}}let r=i(process.env.FIREBASE_SERVICE_ACCOUNT_BASE64||process.env.FIREBASE_PRIVATE_KEY_BASE64||"");if(r&&r.client_email&&r.private_key){let e=r.project_id||process.env.FIREBASE_PROJECT_ID,t=r.client_email,n=String(r.private_key).replace(/\\n/g,"\n");if(e&&t&&n)return{projectId:e,clientEmail:t,privateKey:n}}let n=process.env.FIREBASE_PROJECT_ID||process.env.GOOGLE_CLOUD_PROJECT||process.env.GCLOUD_PROJECT,o=process.env.FIREBASE_CLIENT_EMAIL,s=(process.env.FIREBASE_PRIVATE_KEY||"").replace(/\\n/g,"\n");if(!n||!o||!s)throw Error("Firebase Admin credentials not found. Set GOOGLE_APPLICATION_CREDENTIALS_JSON to the FULL service account JSON   (or) FIREBASE_SERVICE_ACCOUNT_BASE64 with the JSON base64-encoded,   (or) FIREBASE_PROJECT_ID + FIREBASE_CLIENT_EMAIL + FIREBASE_PRIVATE_KEY.");return{projectId:n,clientEmail:o,privateKey:s}}()),t=0===(0,n.getApps)().length?(0,n.initializeApp)({credential:e}):(0,n.getApp)(),r=(0,o.getFirestore)(t),a=(0,s.getAuth)(t);return{app:t,db:r,auth:a}}()),e[a]})()},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=6765);module.exports=r})();