"use strict";(()=>{var e={};e.id=749,e.ids=[749],e.modules={5877:e=>{e.exports=require("firebase-admin/auth")},2594:e=>{e.exports=require("firebase-admin/firestore")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},5012:(e,t,r)=>{r.r(t),r.d(t,{config:()=>c,default:()=>d,routeModule:()=>E});var n={};r.r(n),r.d(n,{default:()=>l});var o=r(1802),a=r(7153),s=r(6249),i=r(2091),u=r(2594);async function l(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,POST,OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(204).end();let{db:r,auth:n}=i.default;try{let o=e.headers.authorization||"",a=o.startsWith("Bearer ")?o.slice(7):"";if(!a)return t.status(401).json({error:"Missing bearer token"});let s=(await n.verifyIdToken(a)).uid,i=("GET"===e.method?e.query.projectId||"":e.body?.projectId||"").trim();if(!i)return t.status(400).json({error:"projectId is required"});let l=r.collection("projects").doc(i),d=await l.get();if(!d.exists)return t.status(404).json({error:"Project not found"});let c=d.data()||{},E=c.ownerId===s,A=!!c.members?.[s];if(!E&&!A)return t.status(403).json({error:"Forbidden: not a project member"});let p=l.collection("meta").doc("takt");if("GET"===e.method){let e=await p.get(),r=e.exists?e.data():void 0,n=Array.isArray(r?.zones)?r.zones:[],o=Array.isArray(r?.trades)?r.trades:[];return t.status(200).json({projectId:i,zones:n,trades:o,updatedAt:r?.updatedAt??null,updatedBy:r?.updatedBy??null})}if("POST"===e.method){let{zones:r=[],trades:n=[]}=e.body||{},o=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],a=o(r),l=o(n);return await p.set({zones:a,trades:l,updatedAt:u.FieldValue.serverTimestamp(),updatedBy:s},{merge:!0}),t.status(200).json({ok:!0,projectId:i,zones:a,trades:l})}return t.setHeader("Allow","GET, POST, OPTIONS"),t.status(405).json({error:"Method not allowed"})}catch(r){console.error("taktMeta error:",r);let e=r?.errorInfo?.message||r?.message||"Server error";if(e.toLowerCase().includes("token"))return t.status(401).json({error:e});return t.status(500).json({error:e})}}let d=(0,s.l)(n,"default"),c=(0,s.l)(n,"config"),E=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/taktMeta",pathname:"/api/taktMeta",bundlePath:"",filename:""},userland:n})},2091:(e,t,r)=>{r.d(t,{default:()=>u});let n=require("firebase-admin/app");var o=r(2594),a=r(5877);function s(e){if(!e)return null;try{let t=Buffer.from(e,"base64").toString("utf8");return JSON.parse(t)}catch{return null}}let i="__taktr_admin__",u=(()=>{let e=globalThis;return e[i]||(e[i]=function(){let e=(0,n.cert)(function(){let e=process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON,t=function(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}(e)||s(e||"");if(t&&t.client_email&&t.private_key){let e=t.project_id||process.env.FIREBASE_PROJECT_ID,r=t.client_email,n=String(t.private_key).replace(/\\n/g,"\n");if(e&&r&&n)return{projectId:e,clientEmail:r,privateKey:n}}let r=s(process.env.FIREBASE_SERVICE_ACCOUNT_BASE64||process.env.FIREBASE_PRIVATE_KEY_BASE64||"");if(r&&r.client_email&&r.private_key){let e=r.project_id||process.env.FIREBASE_PROJECT_ID,t=r.client_email,n=String(r.private_key).replace(/\\n/g,"\n");if(e&&t&&n)return{projectId:e,clientEmail:t,privateKey:n}}let n=process.env.FIREBASE_PROJECT_ID||process.env.GOOGLE_CLOUD_PROJECT||process.env.GCLOUD_PROJECT,o=process.env.FIREBASE_CLIENT_EMAIL,a=(process.env.FIREBASE_PRIVATE_KEY||"").replace(/\\n/g,"\n");if(!n||!o||!a)throw Error("Firebase Admin credentials not found. Set GOOGLE_APPLICATION_CREDENTIALS_JSON to the FULL service account JSON   (or) FIREBASE_SERVICE_ACCOUNT_BASE64 with the JSON base64-encoded,   (or) FIREBASE_PROJECT_ID + FIREBASE_CLIENT_EMAIL + FIREBASE_PRIVATE_KEY.");return{projectId:n,clientEmail:o,privateKey:a}}()),t=0===(0,n.getApps)().length?(0,n.initializeApp)({credential:e}):(0,n.getApp)(),r=(0,o.getFirestore)(t),i=(0,a.getAuth)(t);return{app:t,db:r,auth:i}}()),e[i]})()},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=5012);module.exports=r})();