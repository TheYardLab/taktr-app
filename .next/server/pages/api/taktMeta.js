"use strict";(()=>{var e={};e.id=749,e.ids=[749],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3263:e=>{e.exports=import("firebase-admin/app")},9637:e=>{e.exports=import("firebase-admin/auth")},2929:e=>{e.exports=import("firebase-admin/firestore")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},2616:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>l,routeModule:()=>c});var a=r(1802),o=r(7153),s=r(6249),i=r(6453),u=e([i]);i=(u.then?(await u)():u)[0];let l=(0,s.l)(i,"default"),d=(0,s.l)(i,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/taktMeta",pathname:"/api/taktMeta",bundlePath:"",filename:""},userland:i});n()}catch(e){n(e)}})},535:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{default:()=>d});var a=r(3263),o=r(2929),s=r(9637),i=e([a,o,s]);function u(e){if(!e)return null;try{let t=Buffer.from(e,"base64").toString("utf8");return JSON.parse(t)}catch{return null}}[a,o,s]=i.then?(await i)():i;let l="__taktr_admin__",d=(()=>{let e=globalThis;return e[l]||(e[l]=function(){let e=(0,a.cert)(function(){let e=process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON,t=function(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}(e)||u(e||"");if(t&&t.client_email&&t.private_key){let e=t.project_id||process.env.FIREBASE_PROJECT_ID,r=t.client_email,n=String(t.private_key).replace(/\\n/g,"\n");if(e&&r&&n)return{projectId:e,clientEmail:r,privateKey:n}}let r=process.env.FIREBASE_SERVICE_ACCOUNT_BASE64||process.env.FIREBASE_PRIVATE_KEY_BASE64,n=u(r||"");if(n&&n.client_email&&n.private_key){let e=n.project_id||process.env.FIREBASE_PROJECT_ID,t=n.client_email,r=String(n.private_key).replace(/\\n/g,"\n");if(e&&t&&r)return{projectId:e,clientEmail:t,privateKey:r}}let a=process.env.FIREBASE_PROJECT_ID||process.env.GOOGLE_CLOUD_PROJECT||process.env.GCLOUD_PROJECT,o=process.env.FIREBASE_CLIENT_EMAIL,s=(process.env.FIREBASE_PRIVATE_KEY||"").replace(/\\n/g,"\n");if(!a||!o||!s)throw Error("Firebase Admin credentials not found. Set GOOGLE_APPLICATION_CREDENTIALS_JSON to the FULL service account JSON   (or) FIREBASE_SERVICE_ACCOUNT_BASE64 with the JSON base64-encoded,   (or) FIREBASE_PROJECT_ID + FIREBASE_CLIENT_EMAIL + FIREBASE_PRIVATE_KEY.");return{projectId:a,clientEmail:o,privateKey:s}}()),t=0===(0,a.getApps)().length?(0,a.initializeApp)({credential:e}):(0,a.getApp)(),r=(0,o.getFirestore)(t),n=(0,s.getAuth)(t);return{app:t,db:r,auth:n}}()),e[l]})();n()}catch(e){n(e)}})},6453:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>i});var a=r(535),o=r(2929),s=e([a,o]);async function i(e,t){if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,POST,OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(204).end();let{db:r,auth:n}=a.default;try{let a=e.headers.authorization||"",s=a.startsWith("Bearer ")?a.slice(7):"";if(!s)return t.status(401).json({error:"Missing bearer token"});let i=(await n.verifyIdToken(s)).uid,u=("GET"===e.method?e.query.projectId||"":e.body?.projectId||"").trim();if(!u)return t.status(400).json({error:"projectId is required"});let l=r.collection("projects").doc(u),d=await l.get();if(!d.exists)return t.status(404).json({error:"Project not found"});let c=d.data()||{},p=c.ownerId===i,E=!!c.members?.[i];if(!p&&!E)return t.status(403).json({error:"Forbidden: not a project member"});let A=l.collection("meta").doc("takt");if("GET"===e.method){let e=await A.get(),r=e.exists?e.data():void 0,n=Array.isArray(r?.zones)?r.zones:[],a=Array.isArray(r?.trades)?r.trades:[];return t.status(200).json({projectId:u,zones:n,trades:a,updatedAt:r?.updatedAt??null,updatedBy:r?.updatedBy??null})}if("POST"===e.method){let{zones:r=[],trades:n=[]}=e.body||{},a=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],s=a(r),l=a(n);return await A.set({zones:s,trades:l,updatedAt:o.FieldValue.serverTimestamp(),updatedBy:i},{merge:!0}),t.status(200).json({ok:!0,projectId:u,zones:s,trades:l})}return t.setHeader("Allow","GET, POST, OPTIONS"),t.status(405).json({error:"Method not allowed"})}catch(r){console.error("taktMeta error:",r);let e=r?.errorInfo?.message||r?.message||"Server error";if(e.toLowerCase().includes("token"))return t.status(401).json({error:e});return t.status(500).json({error:e})}}[a,o]=s.then?(await s)():s,n()}catch(e){n(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=2616);module.exports=r})();